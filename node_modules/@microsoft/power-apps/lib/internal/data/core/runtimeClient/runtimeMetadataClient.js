/*!
 * Copyright (C) Microsoft Corporation. All rights reserved.
 */
import { ErrorCodes, getErrorMessage, PowerDataRuntimeError } from '../error/error';
/**
 * RuntimeMetadataClient handles metadata operations through PowerOperationExecutor
 */
export class RuntimeMetadataClient {
    _powerOperationExecutor;
    // Static identifiers for services and actions
    // Used to identify specific services and actions within the PowerApps environment
    // These identifiers are used to execute operations through the PowerOperationExecutor
    // The services provide the functionality for the operations
    static SERVICES = {
        powerAppsClient: 'AppPowerAppsClientPlugin',
    };
    // The actions define the specific operations to be performed
    static ACTIONS = {
        getConnectionConfigs: 'loadAppConnectionsAsync_v2',
        getDataSourceConfigs: 'getAppCdsDataSourceConfigsAsync',
    };
    // Private member for the PowerOperationExecutor
    // The PowerOperationExecutor is used to execute operations on the clients
    constructor(_powerOperationExecutor) {
        this._powerOperationExecutor = _powerOperationExecutor;
    }
    /**
     * Creates a new instance of RuntimeMetadataClient
     * @param powerOperationExecutor - The powerOperationExecutor instance
     * @returns Promise resolving to IRuntimeMetadataClient
     */
    static createInstanceAsync(powerOperationExecutor) {
        return Promise.resolve(new RuntimeMetadataClient(powerOperationExecutor));
    }
    /**
     * Fetches app connection configurations
     * @returns Promise resolving to connection reference details
     * @throws Error if the operation fails
     */
    async getAppConnectionConfigsAsync() {
        try {
            const config = {
                service: RuntimeMetadataClient.SERVICES.powerAppsClient,
                action: RuntimeMetadataClient.ACTIONS.getConnectionConfigs,
                params: [],
            };
            const result = await this._executeOperation(config);
            return { success: true, data: result };
        }
        catch (error) {
            throw new PowerDataRuntimeError(ErrorCodes.ConnectionConfigFetchFailed, getErrorMessage(error));
        }
    }
    /**
     * Fetches app data source configurations
     * @returns Promise resolving to connection reference details
     * @throws Error if the operation fails
     */
    async getAppDataSourceConfigsAsync() {
        try {
            const config = {
                service: RuntimeMetadataClient.SERVICES.powerAppsClient,
                action: RuntimeMetadataClient.ACTIONS.getDataSourceConfigs,
                params: [],
            };
            const result = await this._executeOperation(config);
            return { success: true, data: result };
        }
        catch (error) {
            throw new PowerDataRuntimeError(ErrorCodes.DataSourceConfigFetchFailed, getErrorMessage(error));
        }
    }
    /**
     * Executes a metadata operation with the given configuration
     * @param config - The operation configuration
     * @returns Promise resolving to the operation result
     * @throws Error if the operation fails
     */
    async _executeOperation(config) {
        try {
            const result = await this._powerOperationExecutor.execute(config.service, config.action, config.params || []);
            // Convert the keys of the result to lowercase
            const lowerCaseResult = Object.keys(result.data).reduce((acc, key) => {
                acc[key.toLowerCase()] = (result.data ?? {})[key];
                return acc;
            }, {});
            return lowerCaseResult;
        }
        catch {
            throw new PowerDataRuntimeError(ErrorCodes.InvalidMetadataResponse);
        }
    }
}
//# sourceMappingURL=runtimeMetadataClient.js.map